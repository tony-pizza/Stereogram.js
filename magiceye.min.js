/*! MagicEye.js (https://github.com/peeinears/MagicEye.js)
 *
 *  MIT License (http://www.opensource.org/licenses/mit-license.html)
 *  Copyright (c) 2014 Ian Pearce
 */
!function(){"use strict";window.MagicEye=function(a){a||(a={}),this.el=a.el;for(var b in this.defaultOptions)this[b]=a&&a[b]?a[b]:this.defaultOptions[b];return this.palette||(this.palette=this.generatePalette(this.numColors)),this},MagicEye.prototype.defaultOptions={width:400,height:300,numColors:10,depthMap:"0",adaptToElementSize:!1},MagicEye.prototype.randomRGB=function(){return[Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random()),255]},MagicEye.prototype.generatePalette=function(a){for(var b=[],c=0;a>c;c++)b.push(this.randomRGB());return b},MagicEye.prototype.generatePixelData=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q=72,r=Math.round(2.5*q),s=1/3,t=[];for(f=0;b>f;f++){for(o=[],p=[],e=0;a>e;e++)p[e]=e;for(e=0;a>e;e++)if(n=c[f][e],m=Math.round((1-s*n)*r/(2-s*n)),g=Math.round(e-(m+(m&f&1))/2),h=g+m,g>=0&&a>h){j=1;do k=n+2*(2-s*n)*j/(s*r),i=c[f][e-j]<k&&c[f][e+j]<k,j++;while(i&&1>k);if(i){for(l=p[g];l!==g&&l!==h;l=p[g])h>l?g=l:(g=h,h=l);p[g]=h}}for(e=a-1;e>=0;e--)o[e]=p[e]===e?Math.floor(Math.random()*d):o[p[e]];t[f]=o}return t},MagicEye.prototype.formatDepthMap=function(a,b,c){var d,e,f,g,h=0,i=0,j=[];if("string"==typeof c&&(c=c.split(/\n/)),"object"!=typeof c||!c.hasOwnProperty(0))throw"Stereogram.formatDepthMap: invalid depth map template format";if(h=c.length,"string"==typeof c[0])for(e=0;h>e;e++)c[e]=c[e].replace(/ /g,"0"),c[e]=c[e].replace(/[^\d\n]/g,"1"),c[e]=c[e].split("").map(function(a){return parseInt(a)});if("object"!=typeof c[0])throw"Stereogram.formatDepthMap: invalid depth map template format";for(f=0,e=0;h>e;e++)for(c[e].length>i&&(i=c[e].length),d=0;d<c[e].length;d++)c[e][d]>f&&(f=c[e][d]);for(e=0;h>e;e++)for(d=0;i>d;d++)c[e][d]="undefined"==typeof c[e][d]?0:c[e][d]/f;for(e=0;b>e;e++)for(j[e]=[],g=Math.floor(e*h/b),d=0;a>d;d++)j[e].push(c[g][Math.floor(d*i/a)]);return j},MagicEye.prototype.renderPNG=function(a){var b=document.createElement("canvas");return b.width=this.width,b.height=this.height,this.renderToCanvas(b),a.src=b.toDataURL("image/png"),this},MagicEye.prototype.renderToCanvas=function(a){this.setupRender();var b,c,d,e,f,g,h=a.getContext("2d"),i=h.createImageData(this.width,this.height);for(c=0;c<this.height;c++)for(f=c*this.width*4,b=0;b<this.width;b++)for(e=this.palette[this.pixels[c][b]],g=4*b,d=0;4>d;d++)i.data[f+g+d]=e[d];return h.putImageData(i,0,0),this},MagicEye.prototype.regeneratePalette=function(a){return this.numColors=a||this.numColors,this.palette=this.generatePalette(this.numColors),this},MagicEye.prototype.setupRender=function(){return this.rawDepthMap=this.formatDepthMap(this.width,this.height,this.depthMap),this.pixels=this.generatePixelData(this.width,this.height,this.rawDepthMap,this.numColors),this},MagicEye.prototype.render=function(){var a="string"==typeof this.el?document.getElementById(this.el):this.el;if(!a||!a.tagName)throw"MagicEye.render(): invalid element: "+a;if(this.adaptToElementSize){if(!a||!a.tagName)throw"Stereogram.render: invalid element: "+a;if("number"!=typeof a.width||"number"!=typeof a.height)throw"Stereogram.render: adaptToElementSize set to true, but size of element "+a+" is unknown";this.width=a.width,this.height=a.height}if("img"===a.tagName.toLowerCase())this.renderPNG(a);else{if("canvas"!==a.tagName.toLowerCase())throw"MagicEye.render(): invalid element, can only render to <img> or <canvas>";this.renderToCanvas(a)}return this}}();